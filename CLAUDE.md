# CLAUDE.md — Claude Code 最適化アーキテクチャ指針

## プロジェクト概要

<!-- プロジェクト固有の情報をここに記載 -->
- **プロジェクト名**: （未定）
- **技術スタック**: （未定）
- **概要**: （未定）

---

## 1. ディレクトリ構造の原則

### 1.1 フラットで浅い構造を維持する

- ネストは最大3階層まで（`src/feature/component.ts`）
- 4階層以上になる場合は構造を見直す

### 1.2 機能単位でグルーピングする

```
src/
  auth/
    login.ts
    login.test.ts
    signup.ts
    signup.test.ts
  user/
    profile.ts
    profile.test.ts
    settings.ts
    settings.test.ts
  shared/
    http-client.ts
    validator.ts
```

- レイヤー分割（controllers/, services/, models/）ではなく機能分割を優先する
- 関連ファイルは同じディレクトリに置く（コロケーション）

### 1.3 特殊ディレクトリの命名

| ディレクトリ | 用途 |
|---|---|
| `src/` | アプリケーションコード |
| `src/shared/` | 複数機能から参照される共通コード |
| `tests/` | E2Eテスト・統合テスト（ユニットテストはコロケーション） |
| `scripts/` | ビルド・デプロイ等の運用スクリプト |
| `docs/` | ドキュメント |
| `config/` | 設定ファイル |

---

## 2. ファイル設計の原則

### 2.1 1ファイル1責務

- 1ファイルの推奨行数: **200行以下**（最大でも300行）
- 1ファイルには1つの主要なエクスポートを持たせる
- ファイルが大きくなったら機能単位で分割する

### 2.2 命名規則

- **ファイル名はケバブケースを使う**: `user-profile.ts`, `auth-service.ts`
- **ファイル名から内容が推測できること**: `validate-email.ts` > `utils.ts`
- **汎用的な名前を避ける**: `helpers.ts`, `utils.ts`, `common.ts` は使わない
- **テストファイル**: `{対象ファイル名}.test.{ext}` で統一

### 2.3 インデックスファイルの制限

- `index.ts` はモジュールの公開APIを定義する場合のみ使用する
- ロジックを `index.ts` に書かない（re-exportのみ）
- 不要な `index.ts` は作成しない

---

## 3. コーディング規約

### 3.1 明示性を優先する

- 暗黙的な動作よりも明示的なコードを書く
- 省略記法よりも可読性を優先する
- マジックナンバー・マジックストリングは定数化する

### 3.2 命名規約

| 対象 | 規約 | 例 |
|---|---|---|
| 変数・関数 | キャメルケース | `getUserById`, `isValid` |
| 定数 | アッパースネークケース | `MAX_RETRY_COUNT`, `API_BASE_URL` |
| 型・クラス | パスカルケース | `UserProfile`, `AuthService` |
| ファイル名 | ケバブケース | `user-profile.ts` |
| ブール変数 | `is/has/can/should` プレフィクス | `isActive`, `hasPermission` |

### 3.3 関数設計

- 1関数の行数: **20行以下**を目安にする
- 引数は3つ以下。超える場合はオブジェクト引数にする
- 副作用のある関数とない関数を分離する
- 早期リターンで条件分岐のネストを浅く保つ

### 3.4 エラーハンドリング

- エラーは握りつぶさない
- 境界（外部入力・API呼び出し）でバリデーションする
- 内部関数間では信頼し、過剰なバリデーションを避ける

---

## 4. テスト方針

### 4.1 テストファイルの配置

- ユニットテストは対象ファイルと同じディレクトリに置く（コロケーション）
- E2E・統合テストは `tests/` ディレクトリに置く

### 4.2 テストの命名

```
describe("関数名 or クラス名", () => {
  it("条件 → 期待される結果", () => { ... });
});
```

例: `it("メールアドレスが空の場合 → バリデーションエラーを返す")`

### 4.3 テスト構造

- **Arrange-Act-Assert** パターンを使う
- 1テストケースにつき1アサーションを原則とする
- テストデータはテスト内にインラインで定義する（外部ファイル参照を避ける）

---

## 5. 依存関係の方針

### 5.1 依存の方向を単方向に保つ

```
機能モジュール → shared/ → 外部ライブラリ
```

- 循環依存は禁止
- `shared/` は他の機能モジュールに依存しない
- 機能モジュール間の直接依存は最小限にする

### 5.2 インポートの規約

インポートの順序を統一する:

```
1. 言語標準ライブラリ / ランタイム
2. 外部ライブラリ（npm, pip, crates等）
3. プロジェクト内 shared/
4. 同一機能内の他ファイル
```

- 各グループ間に空行を入れる
- ワイルドカードインポートは使わない

---

## 6. Claude Code への作業指示

### 6.1 コミット規約

Conventional Commits に従う:

```
<type>: <簡潔な説明>
```

| type | 用途 |
|---|---|
| `feat` | 新機能 |
| `fix` | バグ修正 |
| `refactor` | リファクタリング |
| `test` | テストの追加・修正 |
| `docs` | ドキュメント |
| `chore` | ビルド・設定等の雑務 |

### 6.2 作業フロー

1. 変更前にまず既存コードを読んで理解する
2. 既存のパターン・規約に従って実装する
3. 小さな単位で変更し、各変更が動作する状態を保つ
4. テストを書いてから実装する、または実装と同時にテストを書く
5. 変更後に既存テストが通ることを確認する

### 6.3 コード変更時の注意

- 既存の命名規則・コードスタイルに合わせる
- 変更に関係ないコードを修正しない
- 使われていないコードは削除してよい（コメントアウトで残さない）
- TODO コメントには必ず具体的な内容を書く: `// TODO: ユーザー削除時にセッションを無効化する`
